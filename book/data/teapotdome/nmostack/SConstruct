from rsf.proj import *

# SConscript('../fetch/SConstruct')

Flow('foldplot','../fetch/npr3_gathers_hdr.rsf',
    '''
      dd type=float |
      fold 
          verbose=1
          o1=0 n1=96  d1=200 label1=offset
          o2=1 n2=188 d2=1   label2=xline
          o3=1 n3=345 d3=1   label3=iline          
    ''')

Plot('foldplot',
     '''
     grey title=foldplot gainpanel=all pclip=100 
     ''',view=1)

Result('foldplot',
       '''
       byte gainpanel=all allpos=y |
       grey3 title=foldplot frame1=50 frame2=100 frame3=100
       ''')

Flow('gathers mask','../fetch/npr3_gathers.rsf ../fetch/npr3_gathers_hdr.rsf',
     'intbin3 head=${SOURCES[1]} xkey=-1 mask=${TARGETS[1]}')

Flow('fold','mask','dd type=float | stack axis=1 norm=n')

Result('fold',
       '''
       grey transp=n yreverse=n title=Fold allpos=y color=j scalebar=y 
       label1=Inline unit1= label2=Crossline
       ''')

Flow('offset','../fetch/npr3_gathers_hdr.rsf',
     'window n1=1 f1=11 squeeze=n | intbin3 head=$SOURCE xkey=-1 | dd type=float')

tnmo=(0.000,0.373,0.619,0.826,0.909,1.017,1.132,1.222,1.716,3.010)
vnmo=(9086.27,10244.26,11085.81,10803.11,10969.02,11578.66,12252.14,12669.89,14590.08,17116.54)

Flow('vnmo.asc',None,
     '''
     echo %s n1=%d n2=2 data_format=ascii_float in=$TARGET
     ''' % (' '.join(map(str,tnmo)+map(str,vnmo)),len(tnmo)))
Flow('vnmo','vnmo.asc gathers',
     'dd form=native | linear pattern=${SOURCES[1]} rect=5 niter=100')
 
Result('vnmo','graph title="NMO Velocity" label1=Time unit1=s label2=Velocity unit2=ft/s')

Flow('vnmo3','vnmo','spray axis=1 n=1 | spray axis=3 n=188 | spray axis=4 n=345')
Flow('mask3','mask','spray axis=1 n=1')

Flow('nmo','gathers offset vnmo3 mask3',
     '''
     nmo offset=${SOURCES[1]} half=n velocity=${SOURCES[2]} mask=${SOURCES[3]}
     ''',split=[4,345])

Flow('stack','nmo','stack',split=[4,345],reduce='cat axis=3')

Result('stack',
       '''
       window n1=1000
       | byte gainpanel=all 
       | grey3 title=Stack frame1=500 frame2=120 frame3=140
        ''')

# Velocity analysis at one CMP
Flow('gather1','gathers','window n3=1 n4=1 f3=120 f4=140')
Flow('offset1','offset', 'window n3=1 n4=1 f3=120 f4=140')
Flow('mask1','mask3',    'window n3=1 n4=1 f3=120 f4=140')

Result('gather1','gather1 offset1',
       '''
       wiggle xpos=${SOURCES[1]} transp=y poly=y yreverse=y title="CMP Gather" 
       label2=Offset unit2=ft
       ''')

Flow('vscan1','gather1 offset1 mask1',
     'vscan offset=${SOURCES[1]} mask=${SOURCES[2]} v0=9000 nv=101 dv=100 semblance=y half=n nb=10')

Result('vscan1','grey color=j allpos=y title="Semblance Scan" unit2=ft/s')

# Try a supergather???

End()
