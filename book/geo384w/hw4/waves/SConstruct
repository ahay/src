from rsfproj import *
from math import *

##############################################
#
# !!!! CHANGE ME 

h = 0

#
##############################################

alpha = pi/6
a = tan(alpha)

# Make a reflector model 
Flow('refl',None,
     '''
     math n1=901 o1=0 d1=0.01 output="sqrt(%g^2+(x1*%g)^2)" 
     ''' % (h,a))

# Reflector dip
Flow('dip','refl','math output="%g*x1/input" ' % (a*a))

# Kirchoff modeling
Flow('data','refl dip',
     '''
     kirmod nt=1501 ns=5 s0=1 ds=0.5 nh=401 dh=0.01 h0=-0.5
     twod=y vel=1 freq=5 dip=${SOURCES[1]} verb=y
     ''')

# Reflection traveltime

##############################################
#
# !!!! CHANGE ME 

eq = 'sqrt(x2^2+(x1+x2)^2-2*x2*(x1+x2)*%g)' % cos(2*alpha) 

#
##############################################

Flow('time','data',
     'window n1=1 | math output="%s" ' % eq)

shots = []
for s in (0,2,4):
    shot = 'shot%s' % s
    Flow(shot,'data','window n3=1 f3=%d' % s)
    Plot(shot,
         '''
         grey title="Shot at %d km" 
         label1=Time unit1=s label2=Offset unit2=km
         labelsz=10 titlesz=15
         ''' % (1+0.5*s))

    time = 'time%s' % s
    Flow(time,'time','window n2=1 f2=%d' % s)
    Plot(time,
         '''
         graph plotcol=3 wanttitle=n wantaxis=n 
         min2=0 max2=6 pad=n yreverse=y
         ''')

    Plot(shot+'o',[shot,time],'Overlay')
    shots.append(shot+'o')
Result('shots',shots,'SideBySideAniso')

# Velocity for imaging

vel = 1

Flow('water',None,
     '''
     spike mag=%g 
     n1=201 d1=0.01 n2=301 d2=0.01
     ''' % vel)
    
# Kirchhoff migration
Flow('image','data',
     'shotconstkirch nx=301 dx=0.01 x0=0 vel=%g' % vel)

# Stack images from different shot gathers
Flow('stack','image water',
     '''
     halfint inv=y adj=y |
     stack axis=3 |
     time2depth velocity=${SOURCES[1]}
     ''')
    
Result('image','stack',
       '''
       grey pclip=100
       title="Image at Velocity %g km/s" 
       label1=Distance unit1=km
       label1=Depth unit1=km
       ''' % vel)

End()
